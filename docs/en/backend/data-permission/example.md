# Usage Examples  

Using data permissions in code currently supports multiple methods for dynamic enabling and disabling.  
Here are several common development scenarios:

## Controlling Data Permissions for an Entire Model  

Take the default `User` model as an example. Suppose we need to apply data permission control to the `User` model.  

You can use the `DataScopes` trait in the `User` model to enable data permission scoping.  

```php
use App\Library\DataPermission\Scope\DataScopes;

class User {
    // Use the data permission scope
    use DataScopes;

    // Other code...
}
```  

This ensures that all queries on the `User` model automatically apply data permission control.  

## Controlling Data Permissions for a Specific Code Block  

Thanks to Hyperf AOP features, we can use the [DataScope](https://github.com/mineadmin/MineAdmin/blob/master-department/app/Library/DataPermission/Attribute/DataScope.php) annotation on a class or class method to enable data permission control for specific code blocks.  

Take the [pagination list](https://github.com/mineadmin/MineAdmin/blob/master-department/app/Service/Permission/UserService.php#L93~L100) in the built-in user module as an example:  

```php
class UserService
{
    #[DataScope(
        scopeType: ScopeType::CREATED_BY,
        onlyTables: ['user']
    )]
    public function page(array $params, int $page = 1, int $pageSize = 10): array
    {
        return parent::page($params, $page, $pageSize); // TODO: Change the autogenerated stub
    }
}
```  

When the `page` method is called, data permissions will automatically apply to the query.  

## Controlling Permissions for a Specific ORM Query  

In certain scenarios, more granular permission isolation is needed. In such cases, you can use the `Factory::make()->build()` method to restrict a specific Query.  

```php
use App\Library\DataPermission\Factory;
use App\Model\Permission\User;
use App\Model\Permission\Wallet;

class DemoService {
    public function test(User $user): void {
        $walletQuery = Wallet::query();
        // Apply data isolation to WalletQuery separately
        Factory::make()->build($user, $walletQuery->getQuery());
    }
}
```  

## Specifying Alternative Fields for Isolation  

In some cases, business tables may not use the default field names like `created_by` or `dept_id`, or in complex join queries where table names are aliased (e.g., `table as xxxx`). In such situations, you need to specify new isolation fields. Below are examples demonstrating how to specify new fields in different usage scenarios.  

### When Using Annotations to Isolate a Method  

The built-in `DataScope` annotation provides parameters to easily specify new fields:  

```php
<?php

declare(strict_types=1);
/**
 * This file is part of MineAdmin.
 *
 * @link     https://www.mineadmin.com
 * @document https://doc.mineadmin.com
 * @contact  root@imoi.cn
 * @license  https://github.com/mineadmin/MineAdmin/blob/master/LICENSE
 */

namespace App\Library\DataPermission\Attribute;

use App\Library\DataPermission\ScopeType;
use Hyperf\Di\Annotation\AbstractAnnotation;

#[\Attribute(\Attribute::TARGET_CLASS | \Attribute::TARGET_METHOD)]
final class DataScope extends AbstractAnnotation
{
    public function __construct(
        // Specify the department field name
        private readonly string $deptColumn = 'dept_id',
        // Specify the creator field name
        private readonly string $createdByColumn = 'created_by',
        // Isolation method
        private readonly ScopeType $scopeType = ScopeType::DEPT_CREATED_BY,
        // Only isolate specified tables. If empty, all tables are isolated.
        private readonly ?array $onlyTables = null
    ) {}

    public function getOnlyTables(): ?array
    {
        return $this->onlyTables;
    }

    public function getDeptColumn(): string
    {
        return $this->deptColumn;
    }

    public function getCreatedByColumn(): string
    {
        return $this->createdByColumn;
    }

    public function getScopeType(): ScopeType
    {
        return $this->scopeType;
    }
}
```  

### When Manually Using `Factory::make()->build`  

When manually invoking the `Factory` instance to construct conditions, you need to use `App\Library\DataPermission\Context` for configuration.  

```php
use App\Library\DataPermission\Context as Ctx;
use App\Library\DataPermission\Factory;

// Only apply data isolation to the 'sss' table
Ctx::setOnlyTables(['sss']);
// Set the department field name
Ctx::setDeptColumn('department_id');
// Set the creator field name
Ctx::setCreatedByColumn('creator');
// Set the isolation method
Ctx::setScopeType(ScopeType::DEPT_CREATED_BY);

$query = XXXModel::query();

Factory::make()->build($user, $query->getQuery());
```  

::: warning  

Note: Regardless of the method used, if a new coroutine is started, you must reconfigure these settings for them to take effect.  

:::
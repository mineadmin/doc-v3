# MineAdmin 国際化設定完全ガイド

MineAdmin フロントエンドは Vue i18n v11 をベースに構築された完全な国際化ソリューションを提供し、多言語切り替え、動的言語パック読み込み、モジュール化された翻訳管理をサポートしています。このドキュメントでは、システムの国際化実装メカニズムと使用方法を詳しく説明します。

## 概要

### サポート言語
- 簡体字中国語 (zh_CN) - デフォルト言語
- 繁体字中国語 (zh_TW)
- 英語 (en)

### コア機能
- 🌐 多言語動的切り替え
- 📦 モジュール化言語パック管理
- ⚡ 動的言語パック読み込み
- 🔧 開発ツール統合
- 📱 グローバルとローカルスコープサポート
- 🎯 TypeScript タイプセーフ

### 技術スタック
- **Vue i18n**: 11.1.2
- **ビルドプラグイン**: @intlify/unplugin-vue-i18n 6.0.3
- **言語フォーマット**: YAML (JSON サポート)
- **タイプシステム**: TypeScript

## プロジェクト設定

### システム初期化

システムは `/web/src/bootstrap.ts` で国際化設定を初期化します：

```typescript
// ソース位置: web/src/bootstrap.ts:44-67
// GitHub: https://github.com/mineadmin/mineadmin/blob/master/web/src/bootstrap.ts

async function createI18nService(app: App) {
  // 言語パックファイルを自動スキャン
  const locales: any[] = Object.entries(import.meta.glob('./locales/*.y(a)?ml')).map(([key]: any) => {
    const [, value, label] = key.match(/^.\/locales\/(\w+)\[([^[\]]+)\]\.yaml$/)
    return { label, value }
  })
  
  useUserStore().setLocales(locales)
  
  // メッセージフォーマット処理
  Object.keys(messages as any).map((name: string) => {
    const matchValue = name.match(/(\w+)/) as RegExpMatchArray | null
    if (messages && matchValue) {
      messages[matchValue[1]] = messages[name]
      delete messages[name]
    }
  })

  // i18n インスタンス作成
  app.use(createI18n({
    legacy: false,                    // Composition API 使用
    globalInjection: true,            // グローバルインジェクション
    fallbackLocale: 'zh_CN',         // フォールバック言語
    locale: useUserStore().getLanguage(), // 現在の言語
    silentTranslationWarn: true,      // 翻訳警告を無音化
    silentFallbackWarn: true,         // フォールバック警告を無音化
    messages,                         // 言語パックデータ
  }))
}
```

## システムアーキテクチャ

### アーキテクチャ図

```mermaid
graph TB
    A[Vue App] --> B[Bootstrap]
    B --> C[I18n Service]
    C --> D[createI18n]
    D --> E[Global Messages]
    D --> F[Local Messages]
    
    E --> G[Core Locales]
    E --> H[Module Locales]
    E --> I[Plugin Locales]
    
    F --> J[Component i18n blocks]
    
    K[useTrans Hook] --> L[Global Translation]
    K --> M[Local Translation]
    
    N[useLocalTrans Hook] --> M
    
    G --> O[/src/locales/*.yaml]
    H --> P[/src/modules/*/locales/*.yaml]
    I --> Q[/src/plugins/*/locales/*.yaml]
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style K fill:#fff3e0
    style N fill:#fff3e0
```

### ファイル構造

```
web/src/
├── locales/                           # コア言語パック
│   ├── zh_CN[简体中文].yaml
│   ├── en[English].yaml
│   └── zh_TW[繁體中文].yaml
├── modules/                           # モジュール言語パック
│   └── base/
│       └── locales/
│           ├── zh_CN[简体中文].yaml
│           ├── en[English].yaml
│           └── zh_TW[繁體中文].yaml
├── plugins/                           # プラグイン言語パック
│   └── mine-admin/
│       └── code-generator/
│           └── web/
│               └── locales/
│                   ├── zh_CN[简体中文].yaml
│                   ├── en[English].yaml
│                   └── zh_TW[繁體中文].yaml
└── hooks/                             # 国際化 Hooks
    ├── auto-imports/
    │   └── useTrans.ts               # 自動インポート翻訳 Hook
    └── useLocalTrans.ts              # ローカル翻訳 Hook
```

## 言語パック管理

### ファイル命名規則

言語パックファイルは特定のフォーマットに従う必要があります：`言語識別子[言語名].yaml`

```bash
# 正しい命名フォーマット
zh_CN[简体中文].yaml
en[English].yaml  
zh_TW[繁體中文].yaml

# 間違った命名フォーマット
zh_CN.yaml         # 言語名欠如
en[英文].yaml      # 言語名エラー
zh-CN[简体中文].yaml  # 言語識別子フォーマットエラー
```

### グローバル言語パック

システムは以下の3つの場所の言語パックを自動スキャンします：

1. **コア言語パック**: `src/locales/`
2. **モジュール言語パック**: `src/modules/<モジュール名>/locales/`
3. **プラグイン言語パック**: `src/plugins/<プラグイン名>/locales/`

::: danger 重要注意
**モジュール** と **プラグイン** の言語パックファイル名は `src/locales` のファイル名と完全に一致する必要があります。一致しない場合、翻訳キーが見つからないというコンソール警告が表示されます。
:::

### 言語パック内容例

**コア言語パック例** (`src/locales/zh_CN[简体中文].yaml`)：

```yaml
# ログインフォーム
loginForm:
  loginButton: ログイン
  passwordPlaceholder: パスワードを入力してください
  codeLabel: 認証コード
  usernameLabel: アカウント

# CRUD 操作
crud:
  cancel: キャンセル
  save: 保存
  ok: 確定
  add: 新規追加
  edit: 編集
  delete: 削除
  createSuccess: 作成成功
  updateSuccess: 更新成功
  delMessage: 選択したデータを削除しますか？

# フォームバリデーション
form:
  pleaseInput: {msg}を入力してください
  pleaseSelect: {msg}を選択してください
  requiredInput: '{msg}は必須です'
```

### ローカル言語パック

Vue コンポーネントでローカル言語パックを定義：

```vue
<template>
  <div>
    <h1>{{ t('welcome') }}</h1>
    <p>{{ t('description') }}</p>
  </div>
</template>

<script setup lang="ts">
const { t } = useLocalTrans()
</script>

<i18n lang="yaml">
zh_CN:
  welcome: ようこそ
  description: これはサンプルページです
zh_TW:
  welcome: 歡迎使用
  description: 這是一個示例頁面
en:
  welcome: Welcome
  description: This is a sample page
</i18n>
```

## Hook システム詳細

### useTrans Hook

**ソース位置**: `web/src/hooks/auto-imports/useTrans.ts`  
**GitHub**: https://github.com/mineadmin/mineadmin/blob/master/web/src/hooks/auto-imports/useTrans.ts

```typescript
import { useI18n } from 'vue-i18n'
import type { ComposerTranslation } from 'vue-i18n'

export interface TransType {
  globalTrans: ComposerTranslation
  localTrans: ComposerTranslation
}

export function useTrans(key: any | null = null): TransType | string | any {
  const global = useI18n()
  const local = useI18n({
    inheritLocale: true,
    useScope: 'local',
  })

  if (key === null) {
    return {
      localTrans: local.t,
      globalTrans: global.t,
    }
  }
  else {
    // 最初にグローバル翻訳を検索し、次にローカル翻訳を検索
    return global.te(key) ? global.t(key) : local.te(key) ? local.t(key) : key
  }
}
```

### useLocalTrans Hook

**ソース位置**: `web/src/hooks/useLocalTrans.ts`  
**GitHub**: https://github.com/mineadmin/mineadmin/blob/master/web/src/hooks/useLocalTrans.ts

```typescript
import { useI18n } from 'vue-i18n'
import type { ComposerTranslation } from 'vue-i18n'

export function useLocalTrans(key: any | null = null): string | ComposerTranslation | any {
  const { t } = useI18n({
    inheritLocale: true,
    useScope: 'local',
  })
  return key === null ? t as ComposerTranslation : t(key) as string
}
```

## 使用方法

### 基本用法

#### 1. グローバルとローカル翻訳オブジェクト

```vue
<script setup lang="ts">
import type { TransType } from '@/hooks/auto-imports/useTrans.ts'

// 翻訳オブジェクトを取得
const i18n = useTrans() as TransType
const t = i18n.globalTrans  // グローバル翻訳関数
const localT = i18n.localTrans  // ローカル翻訳関数

// 使用例
const title = t('crud.createSuccess')  // "作成成功"
const localTitle = localT('welcome')   // コンポーネント内で定義された翻訳
</script>
```

#### 2. 直接翻訳呼び出し

```typescript
// インテリジェント翻訳：最初にグローバル、次にローカルにフォールバック
const message = useTrans('crud.updateSuccess')  // "更新成功"

// ローカル翻訳のみ使用
const localMessage = useLocalTrans('description')
```

### 実際のプロジェクト例

**ソース位置**: `web/src/modules/base/views/permission/user/index.vue`  
**GitHub**: https://github.com/mineadmin/mineadmin/blob/master/web/src/modules/base/views/permission/user/index.vue

```vue
<script setup lang="tsx">
import type { TransType } from '@/hooks/auto-imports/useTrans.ts'

// 国際化オブジェクトを取得
const i18n = useTrans() as TransType
const t = i18n.globalTrans

// ダイアログ設定で翻訳を使用
const maDialog: UseDialogExpose = useDialog({
  ok: ({ formType }, okLoadingState: (state: boolean) => void) => {
    // 操作タイプに応じて異なるメッセージを表示
    switch (formType) {
      case 'add':
        formRef.value.add().then((res: any) => {
          res.code === ResultCode.SUCCESS 
            ? msg.success(t('crud.createSuccess'))  // "作成成功"
            : msg.error(res.message)
        })
        break
      case 'edit':
        formRef.value.edit().then((res: any) => {
          res.code === 200 
            ? msg.success(t('crud.updateSuccess'))  // "更新成功"
            : msg.error(res.message)
        })
        break
    }
  },
})

// テーブル設定で翻訳を使用
const options = ref<MaProTableOptions>({
  header: {
    mainTitle: () => t('baseUserManage.mainTitle'),
    subTitle: () => t('baseUserManage.subTitle'),
  },
})
</script>
```

### パラメータ付き翻訳

```vue
<template>
  <div>
    <!-- 表示：ユーザー名を入力してください -->
    <el-input :placeholder="t('form.pleaseInput', { msg: 'ユーザー名' })" />
    
    <!-- 表示：ユーザー名は必須です -->
    <span class="error">{{ t('form.requiredInput', { msg: 'ユーザー名' }) }}</span>
  </div>
</template>

<script setup lang="ts">
const { globalTrans: t } = useTrans()
</script>
```

### テンプレートで直接使用

```vue
<template>
  <div>
    <!-- グローバル関数 $t を使用 -->
    <el-button>{{ $t('crud.save') }}</el-button>
    
    <!-- Hook を使用 -->
    <el-button>{{ t('crud.cancel') }}</el-button>
  </div>
</template>
```

## 高度な機能

### 動的言語切り替え

```typescript
// 英語に切り替え
const { locale } = useI18n()
locale.value = 'en'

// またはユーザーストアを使用
const userStore = useUserStore()
userStore.setLanguage('en')
```

### 翻訳キーの存在確認

```typescript
const { te, t } = useI18n()

// キーが存在するか確認
if (te('some.key')) {
  const translation = t('some.key')
} else {
  console.warn('Translation key not found: some.key')
}
```

### 複数形処理

```yaml
# 言語パック定義
en:
  cart:
    items: 'no items | one item | {count} items'
zh_CN:
  cart:
    items: '{count} 個商品'
```

```typescript
// 使用
const itemCount = ref(5)
const message = t('cart.items', itemCount.value)  // "5 個商品"
```

## パフォーマンス最適化

### 遅延読み込み言語パック

```typescript
// オンデマンドで言語パックを読み込み
const loadLanguage = async (locale: string) => {
  try {
    const messages = await import(`../locales/${locale}[${getLocaleName(locale)}].yaml`)
    const { global } = useI18n()
    global.setLocaleMessage(locale, messages.default)
    global.locale.value = locale
  } catch (error) {
    console.error(`Failed to load language pack: ${locale}`, error)
  }
}
```

### キャッシュ最適化

```typescript
// 翻訳結果をキャッシュ
const translationCache = new Map<string, string>()

const cachedT = (key: string, ...args: any[]) => {
  const cacheKey = `${key}-${JSON.stringify(args)}`
  if (translationCache.has(cacheKey)) {
    return translationCache.get(cacheKey)
  }
  
  const result = t(key, ...args)
  translationCache.set(cacheKey, result)
  return result
}
```

## デバッグとトラブルシューティング

### よくある問題

#### 1. 翻訳キーが見つからない

**問題**: コンソールに警告 `Not found 'xxx' key in 'zh_CN' locale messages.` が表示される

**解決策**:
```typescript
// キーが存在するか確認
const { te, t } = useI18n()
const safeT = (key: string, fallback: string = key) => {
  return te(key) ? t(key) : fallback
}
```

#### 2. モジュール言語パックが有効にならない

**問題**: モジュールやプラグインの言語パックが読み込まれない

**解決策**:
1. ファイル名フォーマットが正しいことを確認：`zh_CN[简体中文].yaml`
2. ファイルパスがスキャン範囲内にあることを確認
3. YAML 構文が正しいことを確認

#### 3. タイプエラー

**問題**: TypeScript タイプチェックが失敗する

**解決策**:
```typescript
// 正しいタイプ定義を使用
import type { TransType } from '@/hooks/auto-imports/useTrans.ts'

const i18n = useTrans() as TransType
const t = i18n.globalTrans  // タイプセーフな翻訳関数
```

### 開発ツール

#### IDE プラグイン推奨

- **VSCode**: [i18n Ally](https://marketplace.visualstudio.com/items?itemName=Lokalise.i18n-ally)
- **WebStorm**: [Easy i18n](https://plugins.jetbrains.com/plugin/16316-easy-i18n)

#### デバッグテクニック

```typescript
// 詳細ログを有効化
const i18n = createI18n({
  // ... その他の設定
  silentTranslationWarn: false,  // 翻訳警告を表示
  silentFallbackWarn: false,     // フォールバック警告を表示
  missingWarn: true,            
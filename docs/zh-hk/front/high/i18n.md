# MineAdmin 國際化配置完整指南

MineAdmin 前端基於 Vue i18n v11 構建了完整的國際化解決方案，支持多語言切換、動態語言包加載和模塊化翻譯管理。本文檔將詳細介紹系統的國際化實現機制和使用方法。

## 概述

### 支持的語言
- 簡體中文 (zh_CN) - 默認語言
- 繁體中文 (zh_TW)
- 英文 (en)

### 核心特性
- 🌐 多語言動態切換
- 📦 模塊化語言包管理
- ⚡ 動態語言包加載
- 🔧 開發工具集成
- 📱 全局和局部作用域支持
- 🎯 TypeScript 類型安全

### 技術棧
- **Vue i18n**: 11.1.2
- **構建插件**: @intlify/unplugin-vue-i18n 6.0.3
- **語言格式**: YAML (支持 JSON)
- **類型系統**: TypeScript

## 項目配置

### 系統初始化

系統在 `/web/src/bootstrap.ts` 中初始化國際化配置：

```typescript
// 源碼位置: web/src/bootstrap.ts:44-67
// GitHub: https://github.com/mineadmin/mineadmin/blob/master/web/src/bootstrap.ts

async function createI18nService(app: App) {
  // 自動掃描語言包文件
  const locales: any[] = Object.entries(import.meta.glob('./locales/*.y(a)?ml')).map(([key]: any) => {
    const [, value, label] = key.match(/^.\/locales\/(\w+)\[([^[\]]+)\]\.yaml$/)
    return { label, value }
  })
  
  useUserStore().setLocales(locales)
  
  // 處理消息格式
  Object.keys(messages as any).map((name: string) => {
    const matchValue = name.match(/(\w+)/) as RegExpMatchArray | null
    if (messages && matchValue) {
      messages[matchValue[1]] = messages[name]
      delete messages[name]
    }
  })

  // 創建 i18n 實例
  app.use(createI18n({
    legacy: false,                    // 使用 Composition API
    globalInjection: true,            // 全局注入
    fallbackLocale: 'zh_CN',         // 回退語言
    locale: useUserStore().getLanguage(), // 當前語言
    silentTranslationWarn: true,      // 靜默翻譯警告
    silentFallbackWarn: true,         // 靜默回退警告
    messages,                         // 語言包數據
  }))
}
```

## 系統架構

### 架構圖

```mermaid
graph TB
    A[Vue App] --> B[Bootstrap]
    B --> C[I18n Service]
    C --> D[createI18n]
    D --> E[Global Messages]
    D --> F[Local Messages]
    
    E --> G[Core Locales]
    E --> H[Module Locales]
    E --> I[Plugin Locales]
    
    F --> J[Component i18n blocks]
    
    K[useTrans Hook] --> L[Global Translation]
    K --> M[Local Translation]
    
    N[useLocalTrans Hook] --> M
    
    G --> O[/src/locales/*.yaml]
    H --> P[/src/modules/*/locales/*.yaml]
    I --> Q[/src/plugins/*/locales/*.yaml]
    
    style A fill:#e1f5fe
    style C fill:#f3e5f5
    style K fill:#fff3e0
    style N fill:#fff3e0
```

### 文件結構

```
web/src/
├── locales/                           # 核心語言包
│   ├── zh_CN[簡體中文].yaml
│   ├── en[English].yaml
│   └── zh_TW[繁體中文].yaml
├── modules/                           # 模塊語言包
│   └── base/
│       └── locales/
│           ├── zh_CN[簡體中文].yaml
│           ├── en[English].yaml
│           └── zh_TW[繁體中文].yaml
├── plugins/                           # 插件語言包
│   └── mine-admin/
│       └── code-generator/
│           └── web/
│               └── locales/
│                   ├── zh_CN[簡體中文].yaml
│                   ├── en[English].yaml
│                   └── zh_TW[繁體中文].yaml
└── hooks/                             # 國際化 Hooks
    ├── auto-imports/
    │   └── useTrans.ts               # 自動導入的翻譯 Hook
    └── useLocalTrans.ts              # 局部翻譯 Hook
```

## 語言包管理

### 文件命名規範

語言包文件必須遵循特定格式：`語言標識符[本語言名稱].yaml`

```bash
# 正確的命名格式
zh_CN[簡體中文].yaml
en[English].yaml  
zh_TW[繁體中文].yaml

# 錯誤的命名格式
zh_CN.yaml         # 缺少語言名稱
en[英文].yaml      # 語言名稱錯誤
zh-CN[簡體中文].yaml  # 語言標識符格式錯誤
```

### 全局語言包

系統自動掃描以下三個位置的語言包：

1. **核心語言包**: `src/locales/`
2. **模塊語言包**: `src/modules/<模塊名>/locales/`
3. **插件語言包**: `src/plugins/<插件名>/locales/`

::: danger 重要提醒
**模塊** 和 **插件** 下的語言包文件名必須與 `src/locales` 下的文件名完全一致，否則會出現找不到翻譯鍵的控制枱警告。
:::

### 語言包內容示例

**核心語言包示例** (`src/locales/zh_CN[簡體中文].yaml`)：

```yaml
# 登錄表單
loginForm:
  loginButton: 登錄
  passwordPlaceholder: 請輸入密碼
  codeLabel: 驗證碼
  usernameLabel: 賬户

# CRUD 操作
crud:
  cancel: 取消
  save: 保存
  ok: 確定
  add: 新增
  edit: 編輯
  delete: 刪除
  createSuccess: 創建成功
  updateSuccess: 修改成功
  delMessage: 是否刪除所選中數據？

# 表單驗證
form:
  pleaseInput: 請輸入{msg}
  pleaseSelect: 請選擇{msg}
  requiredInput: '{msg}必填'
```

### 局部語言包

在 Vue 組件中定義局部語言包：

```vue
<template>
  <div>
    <h1>{{ t('welcome') }}</h1>
    <p>{{ t('description') }}</p>
  </div>
</template>

<script setup lang="ts">
const { t } = useLocalTrans()
</script>

<i18n lang="yaml">
zh_CN:
  welcome: 歡迎使用
  description: 這是一個示例頁面
zh_TW:
  welcome: 歡迎使用
  description: 這是一個示例頁面
en:
  welcome: Welcome
  description: This is a sample page
</i18n>
```

## Hook 系統詳解

### useTrans Hook

**源碼位置**: `web/src/hooks/auto-imports/useTrans.ts`  
**GitHub**: https://github.com/mineadmin/mineadmin/blob/master/web/src/hooks/auto-imports/useTrans.ts

```typescript
import { useI18n } from 'vue-i18n'
import type { ComposerTranslation } from 'vue-i18n'

export interface TransType {
  globalTrans: ComposerTranslation
  localTrans: ComposerTranslation
}

export function useTrans(key: any | null = null): TransType | string | any {
  const global = useI18n()
  const local = useI18n({
    inheritLocale: true,
    useScope: 'local',
  })

  if (key === null) {
    return {
      localTrans: local.t,
      globalTrans: global.t,
    }
  }
  else {
    // 優先查找全局翻譯，然後查找局部翻譯
    return global.te(key) ? global.t(key) : local.te(key) ? local.t(key) : key
  }
}
```

### useLocalTrans Hook

**源碼位置**: `web/src/hooks/useLocalTrans.ts`  
**GitHub**: https://github.com/mineadmin/mineadmin/blob/master/web/src/hooks/useLocalTrans.ts

```typescript
import { useI18n } from 'vue-i18n'
import type { ComposerTranslation } from 'vue-i18n'

export function useLocalTrans(key: any | null = null): string | ComposerTranslation | any {
  const { t } = useI18n({
    inheritLocale: true,
    useScope: 'local',
  })
  return key === null ? t as ComposerTranslation : t(key) as string
}
```

## 使用方法

### 基礎用法

#### 1. 全局和局部翻譯對象

```vue
<script setup lang="ts">
import type { TransType } from '@/hooks/auto-imports/useTrans.ts'

// 獲取翻譯對象
const i18n = useTrans() as TransType
const t = i18n.globalTrans  // 全局翻譯函數
const localT = i18n.localTrans  // 局部翻譯函數

// 使用示例
const title = t('crud.createSuccess')  // "創建成功"
const localTitle = localT('welcome')   // 組件內定義的翻譯
</script>
```

#### 2. 直接調用翻譯

```typescript
// 智能翻譯：優先全局，回退到局部
const message = useTrans('crud.updateSuccess')  // "修改成功"

// 僅使用局部翻譯
const localMessage = useLocalTrans('description')
```

### 實際項目案例

**源碼位置**: `web/src/modules/base/views/permission/user/index.vue`  
**GitHub**: https://github.com/mineadmin/mineadmin/blob/master/web/src/modules/base/views/permission/user/index.vue

```vue
<script setup lang="tsx">
import type { TransType } from '@/hooks/auto-imports/useTrans.ts'

// 獲取國際化對象
const i18n = useTrans() as TransType
const t = i18n.globalTrans

// 彈窗配置中使用翻譯
const maDialog: UseDialogExpose = useDialog({
  ok: ({ formType }, okLoadingState: (state: boolean) => void) => {
    // 根據操作類型顯示不同消息
    switch (formType) {
      case 'add':
        formRef.value.add().then((res: any) => {
          res.code === ResultCode.SUCCESS 
            ? msg.success(t('crud.createSuccess'))  // "創建成功"
            : msg.error(res.message)
        })
        break
      case 'edit':
        formRef.value.edit().then((res: any) => {
          res.code === 200 
            ? msg.success(t('crud.updateSuccess'))  // "修改成功"
            : msg.error(res.message)
        })
        break
    }
  },
})

// 表格配置中使用翻譯
const options = ref<MaProTableOptions>({
  header: {
    mainTitle: () => t('baseUserManage.mainTitle'),
    subTitle: () => t('baseUserManage.subTitle'),
  },
})
</script>
```

### 帶參數的翻譯

```vue
<template>
  <div>
    <!-- 顯示：請輸入用户名 -->
    <el-input :placeholder="t('form.pleaseInput', { msg: '用户名' })" />
    
    <!-- 顯示：用户名必填 -->
    <span class="error">{{ t('form.requiredInput', { msg: '用户名' }) }}</span>
  </div>
</template>

<script setup lang="ts">
const { globalTrans: t } = useTrans()
</script>
```

### 模板中直接使用

```vue
<template>
  <div>
    <!-- 使用全局函數 $t -->
    <el-button>{{ $t('crud.save') }}</el-button>
    
    <!-- 使用 Hook -->
    <el-button>{{ t('crud.cancel') }}</el-button>
  </div>
</template>
```

## 高級功能

### 動態語言切換

```typescript
// 切換到英文
const { locale } = useI18n()
locale.value = 'en'

// 或使用用户存儲
const userStore = useUserStore()
userStore.setLanguage('en')
```

### 檢查翻譯鍵是否存在

```typescript
const { te, t } = useI18n()

// 檢查鍵是否存在
if (te('some.key')) {
  const translation = t('some.key')
} else {
  console.warn('Translation key not found: some.key')
}
```

### 複數處理

```yaml
# 語言包定義
en:
  cart:
    items: 'no items | one item | {count} items'
zh_CN:
  cart:
    items: '{count} 個商品'
```

```typescript
// 使用
const itemCount = ref(5)
const message = t('cart.items', itemCount.value)  // "5 個商品"
```

## 性能優化

### 懶加載語言包

```typescript
// 按需加載語言包
const loadLanguage = async (locale: string) => {
  try {
    const messages = await import(`../locales/${locale}[${getLocaleName(locale)}].yaml`)
    const { global } = useI18n()
    global.setLocaleMessage(locale, messages.default)
    global.locale.value = locale
  } catch (error) {
    console.error(`Failed to load language pack: ${locale}`, error)
  }
}
```

### 緩存優化

```typescript
// 緩存翻譯結果
const translationCache = new Map<string, string>()

const cachedT = (key: string, ...args: any[]) => {
  const cacheKey = `${key}-${JSON.stringify(args)}`
  if (translationCache.has(cacheKey)) {
    return translationCache.get(cacheKey)
  }
  
  const result = t(key, ...args)
  translationCache.set(cacheKey, result)
  return result
}
```

## 調試和故障排除

### 常見問題

#### 1. 找不到翻譯鍵

**問題**: 控制枱出現警告 `Not found 'xxx' key in 'zh_CN' locale messages.`

**解決方案**:
```typescript
// 檢查鍵是否存在
const { te, t } = useI18n()
const safeT = (key: string, fallback: string = key) => {
  return te(key) ? t(key) : fallback
}
```

#### 2. 模塊語言包不生效

**問題**: 模塊或插件的語言包沒有被加載

**解決方案**:
1. 確保文件名格式正確：`zh_CN[簡體中文].yaml`
2. 檢查文件路徑是否在掃描範圍內
3. 驗證 YAML 語法是否正確

#### 3. 類型錯誤

**問題**: TypeScript 類型檢查失敗

**解決方案**:
```typescript
// 使用正確的類型定義
import type { TransType } from '@/hooks/auto-imports/useTrans.ts'

const i18n = useTrans() as TransType
const t = i18n.globalTrans  // 類型安全的翻譯函數
```

### 開發工具

#### IDE 插件推薦

- **VSCode**: [i18n Ally](https://marketplace.visualstudio.com/items?itemName=Lokalise.i18n-ally)
- **WebStorm**: [Easy i18n](https://plugins.jetbrains.com/plugin/16316-easy-i18n)

#### 調試技巧

```typescript
// 啓用詳細日誌
const i18n = createI18n({
  // ... 其他配置
  silentTranslationWarn: false,  // 顯示翻譯警告
  silentFallbackWarn: false,     // 顯示回退警告
  missingWarn: true,             // 顯示缺失警告
  fallbackWarn: true,            // 顯示回退警告
})
```

## 測試策略

### 單元測試

```typescript
// tests/i18n.spec.ts
import { mount } from '@vue/test-utils'
import { createI18n } from 'vue-i18n'

describe('i18n Component', () => {
  const i18n = createI18n({
    legacy: false,
    locale: 'zh_CN',
    messages: {
      zh_CN: { hello: '你好' },
      en: { hello: 'Hello' }
    }
  })

  it('renders correct translation', () => {
    const wrapper = mount(TestComponent, {
      global: { plugins: [i18n] }
    })
    expect(wrapper.text()).toContain('你好')
  })

  it('switches language correctly', async () => {
    i18n.global.locale.value = 'en'
    await wrapper.vm.$nextTick()
    expect(wrapper.text()).toContain('Hello')
  })
})
```

### E2E 測試

```typescript
// tests/e2e/i18n.spec.ts
test('language switching works', async ({ page }) => {
  await page.goto('/login')
  
  // 檢查默認語言
  await expect(page.locator('.login-title')).toHaveText('登錄')
  
  // 切換語言
  await page.click('.language-switcher')
  await page.click('[data-lang="en"]')
  
  // 檢查語言切換效果
  await expect(page.locator('.login-title')).toHaveText('Login')
})
```

## 擴展開發

### 添加新語言

1. **創建語言包文件**:
```bash
# 在 src/locales/ 下創建新語言文件
touch src/locales/ja[日本語].yaml
```

2. **添加翻譯內容**:
```yaml
# ja[日本語].yaml
loginForm:
  loginButton: ログイン
  passwordPlaceholder: パスワードを入力してください
  
crud:
  save: 保存
  cancel: キャンセル
```

3. **更新語言配置**:
```typescript
// 如果需要，在初始化時添加新語言支持
const supportedLocales = ['zh_CN', 'en', 'zh_TW', 'ja']
```

### 自定義翻譯邏輯

```typescript
// 創建自定義翻譯 Hook
export function useCustomTrans() {
  const { t, te } = useI18n()
  
  return {
    t: (key: string, fallback?: string) => {
      if (te(key)) {
        return t(key)
      }
      
      // 自定義回退邏輯
      if (fallback) {
        return fallback
      }
      
      // 記錄缺失的翻譯鍵
      console.warn(`Missing translation: ${key}`)
      return key
    }
  }
}
```

## 最佳實踐

### 1. 鍵名命名規範

```yaml
# 推薦：使用命名空間和語義化命名
user:
  profile:
    title: 個人資料
    edit: 編輯資料
  management:
    title: 用户管理
    create: 創建用户

# 避免：過於扁平的結構
userProfileTitle: 個人資料
userProfileEdit: 編輯資料
```

### 2. 組件設計

```vue
<!-- 推薦：將翻譯邏輯封裝在組件內部 -->
<template>
  <div class="user-card">
    <h3>{{ title }}</h3>
    <p>{{ description }}</p>
  </div>
</template>

<script setup lang="ts">
interface Props {
  userId: string
}

const props = defineProps<Props>()
const { t } = useLocalTrans()

const title = computed(() => t('title'))
const description = computed(() => t('description', { id: props.userId }))
</script>

<i18n lang="yaml">
zh_CN:
  title: 用户信息
  description: 用户ID：{id}
en:
  title: User Info
  description: User ID: {id}
</i18n>
```

### 3. 性能考慮

```typescript
// 推薦：緩存計算結果
const translatedOptions = computed(() => {
  return options.map(option => ({
    ...option,
    label: t(`options.${option.key}`)
  }))
})

// 避免：在渲染函數中重複調用翻譯
// {{ options.map(opt => t(`options.${opt.key}`)) }}
```